<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 轉 PPTX 轉換器</title>
    
    <!-- Tailwind CSS 用於樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js 用於解析 PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- PptxGenJS 用於生成 PPTX -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <script>
        // 設定 PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* 自定義動畫與樣式 */
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div class="container mx-auto px-4 py-12 max-w-3xl">
        <!-- 標題區域 -->
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">PDF 轉 PPTX 轉換器</h1>
            <p class="text-slate-500">安全、快速、免費。所有轉換都在瀏覽器內完成，檔案不會上傳。</p>
        </div>

        <!-- 主要卡片 -->
        <div class="bg-white rounded-2xl shadow-xl p-8 transition-all">
            
            <!-- 上傳區域 -->
            <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-10 text-center cursor-pointer transition-colors hover:border-blue-400 hover:bg-slate-50 relative group">
                <input type="file" id="file-input" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                
                <div class="flex flex-col items-center justify-center space-y-4 pointer-events-none">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-lg font-medium text-slate-700">點擊選擇 PDF 或將檔案拖曳至此</p>
                        <p class="text-sm text-slate-400 mt-1">支援各種大小的 PDF 文件</p>
                    </div>
                </div>
            </div>

            <!-- 檔案資訊與轉換控制 (隱藏直到選擇檔案) -->
            <div id="conversion-panel" class="hidden mt-8">
                <div class="flex items-center justify-between bg-slate-100 p-4 rounded-lg mb-6">
                    <div class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <div>
                            <p id="file-name" class="font-medium text-slate-800 truncate max-w-[200px] md:max-w-xs">filename.pdf</p>
                            <p id="file-info" class="text-xs text-slate-500">0 MB • 0 頁</p>
                        </div>
                    </div>
                    <button id="remove-file-btn" class="text-slate-400 hover:text-red-500 p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- 進度條 -->
                    <div id="progress-container" class="hidden">
                        <div class="flex justify-between text-sm mb-1">
                            <span id="status-text" class="font-medium text-blue-600">正在處理...</span>
                            <span id="percentage-text" class="text-slate-500">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 按鈕 -->
                    <button id="convert-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-md shadow-blue-200 flex items-center justify-center space-x-2">
                        <span>開始轉換為 PPTX</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>

                    <button id="download-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-md shadow-green-200 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span>下載 PowerPoint</span>
                    </button>
                </div>
            </div>

            <!-- 隱藏的 Canvas 容器 (用於渲染) -->
            <div id="canvas-container" class="hidden"></div>
        </div>

        <div class="mt-8 text-center text-sm text-slate-400">
            <p>注意：此工具會將 PDF 頁面轉換為高解析度圖片插入投影片中。</p>
            <p>生成的 PPTX 內容無法直接編輯文字，但能保持 100% 原始排版。</p>
        </div>
    </div>

    <script>
        // DOM 元素
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const conversionPanel = document.getElementById('conversion-panel');
        const fileNameEl = document.getElementById('file-name');
        const fileInfoEl = document.getElementById('file-info');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const percentageText = document.getElementById('percentage-text');
        const canvasContainer = document.getElementById('canvas-container');

        let currentFile = null;
        let pptxFile = null; // 儲存生成的 pptx Blob

        // --- 事件監聽 ---

        // 拖曳效果
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('drag-active');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-active');
        }

        // 檔案處理
        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type !== 'application/pdf') {
                    alert('請上傳 PDF 檔案');
                    return;
                }
                currentFile = file;
                updateUIForFile(file);
            }
        }

        function updateUIForFile(file) {
            fileNameEl.textContent = file.name;
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            fileInfoEl.textContent = `${sizeInMB} MB`;
            
            dropZone.classList.add('hidden');
            conversionPanel.classList.remove('hidden');
            
            // 重置狀態
            convertBtn.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        }

        removeFileBtn.addEventListener('click', () => {
            currentFile = null;
            fileInput.value = '';
            dropZone.classList.remove('hidden');
            conversionPanel.classList.add('hidden');
        });

        // --- 核心轉換邏輯 ---

        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            // UI 更新
            convertBtn.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            statusText.textContent = "正在準備 PDF...";
            
            try {
                // 1. 讀取 PDF
                const arrayBuffer = await currentFile.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdfDocument = await loadingTask.promise;
                
                const totalPages = pdfDocument.numPages;
                fileInfoEl.textContent = `${fileInfoEl.textContent.split('•')[0]} • ${totalPages} 頁`;

                // 2. 初始化 PPTX
                const pptx = new PptxGenJS();
                // 設定佈局為寬螢幕 (16:9)，稍後會根據 PDF 頁面大小自動調整
                pptx.layout = 'LAYOUT_16x9'; 

                // 3. 逐頁處理
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    // 更新進度條
                    const percentage = Math.round(((pageNum - 1) / totalPages) * 100);
                    progressBar.style.width = `${percentage}%`;
                    percentageText.textContent = `${percentage}%`;
                    statusText.textContent = `正在處理第 ${pageNum} / ${totalPages} 頁...`;

                    // 取得頁面
                    const page = await pdfDocument.getPage(pageNum);
                    
                    // 設定渲染比例 (Scale)。2.0 提供較好的解析度，但會增加處理時間
                    const scale = 2.0; 
                    const viewport = page.getViewport({ scale: scale });

                    // 創建 Canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // 渲染到 Canvas
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    // 將 Canvas 轉為圖片數據 (Data URL)
                    const imgData = canvas.toDataURL('image/jpeg', 0.8); // 0.8 是壓縮品質，平衡品質與大小

                    // 添加到 PPTX
                    // 根據 PDF 頁面比例動態定義 PPTX 投影片尺寸不太容易 (PPTX 通常全域設定)
                    // 所以我們保持投影片預設大小，讓圖片 "Fit" (適應) 投影片
                    const slide = pptx.addSlide();
                    
                    // 這裡我們讓圖片佔滿整個投影片，可能會留白邊，但能保持比例
                    slide.addImage({
                        data: imgData,
                        x: 0,
                        y: 0,
                        w: '100%',
                        h: '100%',
                        sizing: { type: 'contain', align: 'center' } // 確保圖片完整顯示
                    });
                }

                // 完成
                progressBar.style.width = '100%';
                percentageText.textContent = '100%';
                statusText.textContent = "轉換完成！準備下載...";

                // 4. 生成檔案
                const fileNameNoExt = currentFile.name.replace(/\.[^/.]+$/, "");
                
                // 儲存檔案
                await pptx.writeFile({ fileName: `${fileNameNoExt}.pptx` });

                // UI 更新為完成狀態
                statusText.textContent = "下載已開始";
                setTimeout(() => {
                   // 轉換完成後稍微延遲讓用戶看到 100%，然後顯示下載按鈕(雖然 writeFile 會自動下載，但留個按鈕比較好)
                   downloadBtn.classList.remove('hidden');
                   downloadBtn.onclick = () => pptx.writeFile({ fileName: `${fileNameNoExt}.pptx` });
                   progressContainer.classList.add('hidden');
                }, 1000);

            } catch (error) {
                console.error(error);
                statusText.textContent = "發生錯誤：" + error.message;
                statusText.classList.add('text-red-500');
                convertBtn.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>